<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema de Ventas - Dashboard UI</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
  <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
  
  <script src="https://cdn.sheetjs.com/xlsx-latest/package/dist/xlsx.full.min.js"></script>
  
  <style>
    /* ESTILO MODERNO TIPO DASHBOARD */
    body { background-color: #f3f4f7; font-family: 'Segoe UI', sans-serif; color: #444; }
    
    .main-container { padding: 30px; }
    
    /* Tarjetas estilo "Fab Admin" */
    .card { 
        border: none; 
        border-radius: 15px; 
        box-shadow: 0 5px 20px rgba(0,0,0,0.03); 
        background: white;
        transition: transform 0.2s;
    }
    
    .nav-pills .nav-link.active {
        background-color: #4e73df;
        border-radius: 50px;
        padding: 10px 25px;
        box-shadow: 0 4px 10px rgba(78, 115, 223, 0.4);
    }
    .nav-pills .nav-link { color: #666; font-weight: 600; margin-right: 10px; }
    
    /* Botones Hoja de C√°lculo */
    .toolbar-btn { border-radius: 8px; font-weight: 500; font-size: 0.85rem; }

    /* Ajustes Grilla */
    .jexcel_content { border: 1px solid #eee; border-radius: 8px; overflow: hidden; }
    .jexcel > thead > tr > td { background-color: #f8f9fc; color: #4e73df; font-weight: bold; border-bottom: 2px solid #eef2f7; }
  </style>
</head>
<body>

  <div class="main-container">
    <div class="d-flex justify-content-between align-items-center mb-5">
        <div>
            <h3 class="fw-bold m-0" style="color: #2c3e50;">Panel de Control</h3>
            <small class="text-muted">Gesti√≥n de Ventas y Rendimiento</small>
        </div>
        <div class="d-flex gap-2">
             <select class="form-select border-0 shadow-sm" id="filtroAnio" onchange="cargarDashboard()" style="width: 120px;">
                <option value="2024">2024</option>
                <option value="2025" selected>2025</option>
                <option value="2026">2026</option>
            </select>
        </div>
    </div>

    <ul class="nav nav-pills mb-4" id="myTab" role="tablist">
      <li class="nav-item">
        <button class="nav-link active" id="registro-tab" data-bs-toggle="tab" data-bs-target="#registro" type="button" onclick="cargarGrid()">
            üìù Hoja de Datos
        </button>
      </li>
      <li class="nav-item">
        <button class="nav-link" id="dashboard-tab" data-bs-toggle="tab" data-bs-target="#dashboard" type="button" onclick="cargarDashboard()">
            üìä Dashboard Visual
        </button>
      </li>
    </ul>

    <div class="tab-content" id="myTabContent">
      
      <div class="tab-pane fade show active" id="registro">
        <div class="card p-4">
          
          <div class="d-flex flex-wrap justify-content-between align-items-center mb-3 gap-2">
             <div class="btn-group shadow-sm">
                 <button class="btn btn-light toolbar-btn text-primary" onclick="addRow()">‚ûï Fila</button>
                 <button class="btn btn-light toolbar-btn text-danger" onclick="deleteRow()">üóëÔ∏è Fila</button>
                 <button class="btn btn-light toolbar-btn text-secondary" onclick="addColumn()">‚ûï Columna</button>
                 <button class="btn btn-light toolbar-btn text-secondary" onclick="deleteColumn()">üóëÔ∏è Columna</button>
             </div>
             
             <div class="d-flex gap-2">
                 <input type="file" id="fileUpload" style="display:none" onchange="importarExcel(this)" accept=".xlsx, .xls" />
                 <button class="btn btn-success toolbar-btn text-white shadow-sm" onclick="document.getElementById('fileUpload').click()">
                    Importar Excel
                 </button>
                 <button class="btn btn-primary toolbar-btn fw-bold px-4 shadow" onclick="guardarCambios()">
                    GUARDAR CAMBIOS
                 </button>
             </div>
          </div>

          <div id="spreadsheet" class="w-100"></div>
          <div class="mt-2 text-muted small fst-italic">
              * Nota: Las columnas nuevas que agregues manualmente son solo visuales y no se guardar√°n en la base de datos.
          </div>
        </div>
      </div>

      <div class="tab-pane fade" id="dashboard">
        <div class="row">
            <div class="col-md-8 mb-4">
                <div class="card h-100 p-4">
                    <div class="d-flex justify-content-between align-items-center mb-4">
                        <h5 class="fw-bold m-0 text-secondary">Rendimiento de Ventas</h5>
                        <span class="badge bg-light text-primary">Anual</span>
                    </div>
                    <div style="height: 350px; width: 100%;">
                        <canvas id="graficoMensual"></canvas>
                    </div>
                </div>
            </div>

            <div class="col-md-4 mb-4">
                <div class="card h-100 p-4">
                    <h5 class="fw-bold mb-4 text-secondary">Top Vendedores</h5>
                    <div style="height: 300px; position: relative;">
                        <canvas id="graficoVendedores"></canvas>
                    </div>
                </div>
            </div>
        </div>
      </div>

    </div>
  </div>

  <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- CREDENCIALES ---
    const supabaseUrl = 'https://mgnpegrrkxgghzmnlvid.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nbnBlZ3Jya3hnZ2h6bW5sdmlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MjMzMTIsImV4cCI6MjA4MjI5OTMxMn0.rQHpVNlGTT9NVMsEKPUkfA4c3_FXpiEEdJ2oyJaT_jg'
    const client = supabase.createClient(supabaseUrl, supabaseKey)
    
    let gridInstance = null;
    let chartMensual = null;
    let chartVendedores = null;

    document.addEventListener('DOMContentLoaded', () => {
        cargarGrid();
    });

    // --- 1. CONFIGURACI√ìN DE LA GRILLA ---
    async function cargarGrid() {
        const { data, error } = await client
            .from('ventas')
            .select('id, vendedor, anio, mes, venta, meta')
            .order('anio', { ascending: false });

        if(error) { console.error(error); return; }

        const datosMatriz = data.map(item => [
            item.id, item.vendedor, item.anio, item.mes, item.venta, item.meta
        ]);

        if(gridInstance) document.getElementById('spreadsheet').innerHTML = '';

        gridInstance = jspreadsheet(document.getElementById('spreadsheet'), {
            data: datosMatriz,
            columns: [
                { type: 'hidden', title: 'ID', width: 0 }, 
                { type: 'text', title: 'Vendedor', width: 200 },
                { type: 'numeric', title: 'A√±o', width: 70 },
                { 
                    type: 'dropdown', title: 'Mes', width: 100, 
                    source: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"] 
                },
                { type: 'numeric', title: 'Venta Real', width: 120, mask: '#,##0.00', decimal: '.' },
                { type: 'numeric', title: 'Meta', width: 120, mask: '#,##0.00', decimal: '.' },
            ],
            minDimensions: [6, 15],
            allowInsertColumn: true, 
            allowManualInsertColumn: true, // Permitir agregar columnas visualmente
            defaultColAlign: 'left',
        });
    }

    // --- FUNCIONES DE BOTONES (FILAS Y COLUMNAS) ---
    function addRow() { gridInstance.insertRow(); }
    function deleteRow() { gridInstance.deleteRow(); }
    
    // Funci√≥n Agregar Columna (Visual)
    function addColumn() { 
        gridInstance.insertColumn(); 
    }
    
    // Funci√≥n Eliminar Columna (Visual)
    function deleteColumn() {
        // Elimina la columna seleccionada o la √∫ltima si no hay selecci√≥n
        gridInstance.deleteColumn();
    }

    // --- 2. GUARDADO (IGUAL QUE ANTES) ---
    async function guardarCambios() {
        const datosGrid = gridInstance.getData(); 
        const datosParaSubir = [];

        const limpiarNumero = (valor) => {
            if (!valor) return 0;
            return parseFloat(String(valor).replace(/,/g, ''));
        };

        datosGrid.forEach(fila => {
            // IMPORTANTE: Solo leemos los √≠ndices 0,1,2,3,4,5. 
            // Si agregas columnas (6, 7...), el c√≥digo las ignora aqu√≠ para no romper la BD.
            const id = fila[0];
            const vendedor = fila[1];
            const anio = fila[2];
            const mes = fila[3];
            const venta = limpiarNumero(fila[4]);
            const meta = limpiarNumero(fila[5]);

            if(vendedor && vendedor.trim() !== "") {
                const registro = {
                    vendedor: vendedor,
                    anio: parseInt(anio) || 2025,
                    mes: mes || 'Enero',
                    venta: venta || 0,
                    meta: meta || 0
                };
                if (id && id.length > 5) registro.id = id;
                else registro.id = crypto.randomUUID();
                
                datosParaSubir.push(registro);
            }
        });

        Swal.fire({title: 'Guardando...', didOpen: () => Swal.showLoading()});

        try {
            const { error } = await client.from('ventas').upsert(datosParaSubir);
            if(error) throw error;
            Swal.fire({icon: 'success', title: '¬°Guardado!', timer: 2000, showConfirmButton: false});
            cargarGrid();
        } catch (err) {
            Swal.fire('Error', err.message, 'error');
        }
    }

    // --- 3. IMPORTAR EXCEL ---
    function importarExcel(input) {
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            jsonData.forEach((row, index) => {
                if(index === 0 && typeof row[0] === 'string' && row[0].toLowerCase().includes('vendedor')) return;
                if(row[0]) gridInstance.insertRow(["", row[0], row[1] || 2025, row[2] || "Enero", row[3] || 0, row[4] || 0]);
            });
            input.value = ''; 
            Swal.fire('Cargado', 'Datos importados.', 'success');
        };
        reader.readAsArrayBuffer(file);
    }

    // --- 4. DASHBOARD ESTILO "FAB ADMIN" (PREMIUM) ---
    async function cargarDashboard() {
        const anioSeleccionado = parseInt(document.getElementById('filtroAnio').value);
        const { data } = await client.from('ventas').select('*').eq('anio', anioSeleccionado);
        if(!data) return;

        // Procesar datos
        const mesesOrden = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const ventasPorMes = new Array(12).fill(0);
        
        data.forEach(row => {
            const indexMes = mesesOrden.indexOf(row.mes);
            if(indexMes >= 0) ventasPorMes[indexMes] += row.venta;
        });
        
        // Renderizar Gr√°ficos
        renderChartMensual(mesesOrden, ventasPorMes);

        // Top Vendedores
        const vendedoresMap = {};
        data.forEach(row => {
            if(!vendedoresMap[row.vendedor]) vendedoresMap[row.vendedor] = 0;
            vendedoresMap[row.vendedor] += row.venta;
        });
        const vendedoresArray = Object.keys(vendedoresMap).map(v => ({ nombre: v, total: vendedoresMap[v] }));
        vendedoresArray.sort((a, b) => b.total - a.total);
        renderChartVendedores(vendedoresArray.slice(0, 5)); // Solo Top 5 para que se vea limpio
    }

    // --- GR√ÅFICO 1: LINEA CURVA CON DEGRADADO ---
    function renderChartMensual(labels, ventas) {
        const ctx = document.getElementById('graficoMensual').getContext('2d');
        if (chartMensual) chartMensual.destroy();

        // Crear degradado (Gradient)
        let gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(78, 115, 223, 0.5)'); // Azul transparente arriba
        gradient.addColorStop(1, 'rgba(78, 115, 223, 0.0)'); // Transparente abajo

        chartMensual = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ventas Totales ($)',
                    data: ventas,
                    borderColor: '#4e73df', // Azul bonito
                    backgroundColor: gradient,
                    borderWidth: 3,
                    pointBackgroundColor: '#ffffff',
                    pointBorderColor: '#4e73df',
                    pointRadius: 4,
                    pointHoverRadius: 6,
                    fill: true, // Rellenar √°rea abajo
                    tension: 0.4 // ESTO HACE LA CURVA SUAVE (Spline)
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: {
                    legend: { display: false }, // Ocultar leyenda para look limpio
                    tooltip: {
                        backgroundColor: '#fff',
                        titleColor: '#6e707e',
                        bodyColor: '#858796',
                        borderColor: '#dddfeb',
                        borderWidth: 1,
                        padding: 10,
                        displayColors: false
                    }
                },
                scales: {
                    x: { grid: { display: false } }, // Quitar rejilla vertical
                    y: { 
                        grid: { borderDash: [2], drawBorder: false, color: '#f0f0f0' },
                        beginAtZero: true 
                    }
                }
            }
        });
    }

    // --- GR√ÅFICO 2: DONA MODERNA ---
    function renderChartVendedores(data) {
        const ctx = document.getElementById('graficoVendedores').getContext('2d');
        if (chartVendedores) chartVendedores.destroy();

        chartVendedores = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.nombre),
                datasets: [{
                    data: data.map(d => d.total),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'], // Paleta Admin
                    hoverOffset: 10,
                    borderWidth: 0,
                    borderRadius: 5 // Bordes redondeados en la dona
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%', // Dona m√°s delgada (Estilo moderno)
                plugins: {
                    legend: {
                        position: 'bottom',
                        labels: { usePointStyle: true, padding: 20 }
                    }
                }
            }
        });
    }
  </script>
</body>
</html>
