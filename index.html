<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Sistema Comercial | Ejecutivo</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
  <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
  
  <style>
    :root {
        --sidebar-width: 250px;
        --primary: #2c3e50;    /* Azul Oscuro Ejecutivo */
        --accent: #3498db;     /* Azul Brillante */
        --success: #27ae60;    /* Verde Finanzas */
        --warning: #f39c12;    /* Naranja Proyecci칩n */
        --danger: #c0392b;     /* Rojo Alerta */
        --bg-light: #f4f7f6;
    }

    body { background-color: var(--bg-light); font-family: 'Segoe UI', system-ui, sans-serif; overflow-x: hidden; }

    /* SIDEBAR */
    .sidebar {
        width: var(--sidebar-width);
        position: fixed; top: 0; left: 0; height: 100vh;
        background: var(--primary);
        color: white;
        padding-top: 25px;
        z-index: 1000;
        box-shadow: 4px 0 10px rgba(0,0,0,0.1);
    }
    .sidebar-brand { padding: 0 25px 20px; font-size: 1.1rem; font-weight: 700; letter-spacing: 1px; text-transform: uppercase; border-bottom: 1px solid rgba(255,255,255,0.1); margin-bottom: 20px; }
    .nav-item { padding: 12px 25px; cursor: pointer; opacity: 0.8; transition: 0.2s; display: flex; align-items: center; gap: 12px; font-weight: 500; }
    .nav-item:hover, .nav-item.active { opacity: 1; background: rgba(255,255,255,0.08); border-left: 4px solid var(--accent); }

    /* MAIN */
    .main-content { margin-left: var(--sidebar-width); padding: 30px; }

    /* KPI CARDS (NUEVO DISE칌O) */
    .kpi-grid { display: grid; grid-template-columns: repeat(auto-fit, minmax(200px, 1fr)); gap: 20px; margin-bottom: 30px; }
    .kpi-card {
        background: white; border-radius: 12px; padding: 20px;
        box-shadow: 0 2px 15px rgba(0,0,0,0.04);
        position: relative; overflow: hidden;
        border-bottom: 4px solid transparent;
        transition: transform 0.2s;
    }
    .kpi-card:hover { transform: translateY(-3px); }
    .kpi-label { font-size: 0.75rem; font-weight: 700; text-transform: uppercase; color: #7f8c8d; margin-bottom: 8px; }
    .kpi-value { font-size: 1.6rem; font-weight: 800; color: #2c3e50; }
    .kpi-subtext { font-size: 0.8rem; margin-top: 5px; }
    .kpi-icon { position: absolute; right: 20px; top: 20px; font-size: 2.5rem; opacity: 0.1; }

    /* COLORES KPI */
    .kpi-blue { border-bottom-color: var(--accent); } .kpi-blue .kpi-icon { color: var(--accent); }
    .kpi-green { border-bottom-color: var(--success); } .kpi-green .kpi-icon { color: var(--success); }
    .kpi-orange { border-bottom-color: var(--warning); } .kpi-orange .kpi-icon { color: var(--warning); }
    .kpi-red { border-bottom-color: var(--danger); } .kpi-red .kpi-icon { color: var(--danger); }
    .kpi-purple { border-bottom-color: #9b59b6; } .kpi-purple .kpi-icon { color: #9b59b6; }

    /* CHARTS CONTAINER */
    .chart-box { background: white; border-radius: 12px; padding: 25px; box-shadow: 0 2px 15px rgba(0,0,0,0.04); height: 100%; }
    .chart-title { font-weight: 700; color: var(--primary); margin-bottom: 20px; font-size: 1.1rem; }

    /* GRID */
    .jexcel_content { border: 1px solid #e0e0e0; border-radius: 8px; }
    .jexcel > thead > tr > td { background-color: #ecf0f1; color: var(--primary); font-weight: 700; }
  </style>
</head>
<body>

    <div class="sidebar">
        <div class="sidebar-brand"><i class="bi bi-graph-up-arrow me-2"></i> SALES ADMIN</div>
        <div class="nav-item active" onclick="switchTab('dashboard', this)">
            <i class="bi bi-grid-1x2-fill"></i> Dashboard
        </div>
        <div class="nav-item" onclick="switchTab('registro', this)">
            <i class="bi bi-table"></i> Hoja de Datos
        </div>
        <div class="nav-item" style="margin-top: auto;" onclick="window.location.href='index.html'">
            <i class="bi bi-box-arrow-left"></i> Cerrar Sesi칩n
        </div>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <div>
                <h4 class="fw-bold text-dark m-0">Resumen Ejecutivo</h4>
                <small class="text-muted" id="fechaHoy">Actualizado al d칤a de hoy</small>
            </div>
            <select id="filtroAnio" class="form-select w-auto fw-bold border-0 shadow-sm" onchange="cargarDashboard()">
                <option value="2024">A침o Fiscal 2024</option>
                <option value="2025" selected>A침o Fiscal 2025</option>
                <option value="2026">A침o Fiscal 2026</option>
            </select>
        </div>

        <div id="view-dashboard">
            
            <div class="kpi-grid">
                <div class="kpi-card kpi-blue">
                    <div class="kpi-label">Venta Cerrada (Real)</div>
                    <div class="kpi-value" id="valVenta">$0</div>
                    <div class="kpi-subtext text-muted">Facturaci칩n confirmada</div>
                    <i class="bi bi-cash-stack kpi-icon"></i>
                </div>
                <div class="kpi-card kpi-orange">
                    <div class="kpi-label">Tuber칤a (Proyecci칩n)</div>
                    <div class="kpi-value" id="valTuberia">$0</div>
                    <div class="kpi-subtext text-warning">Pr칩x. Quincena</div>
                    <i class="bi bi-hourglass-split kpi-icon"></i>
                </div>
                <div class="kpi-card kpi-purple">
                    <div class="kpi-label">Forecast (Cierre Est.)</div>
                    <div class="kpi-value" id="valForecast">$0</div>
                    <div class="kpi-subtext" style="color: #9b59b6;">Real + Tuber칤a</div>
                    <i class="bi bi-bar-chart-line-fill kpi-icon"></i>
                </div>
                <div class="kpi-card kpi-green">
                    <div class="kpi-label">Meta Anual</div>
                    <div class="kpi-value" id="valMeta">$0</div>
                    <div class="kpi-subtext" id="txtCumplimiento">0% Cubierto</div>
                    <i class="bi bi-flag-fill kpi-icon"></i>
                </div>
                 <div class="kpi-card kpi-red">
                    <div class="kpi-label">GAP (Faltante)</div>
                    <div class="kpi-value" id="valGap">$0</div>
                    <div class="kpi-subtext text-danger">Para llegar a meta</div>
                    <i class="bi bi-exclamation-triangle-fill kpi-icon"></i>
                </div>
            </div>

            <div class="row g-4">
                <div class="col-lg-8">
                    <div class="chart-box">
                        <div class="chart-title">Evoluci칩n Comercial vs Metas</div>
                        <div style="height: 350px;">
                            <canvas id="chartMain"></canvas>
                        </div>
                    </div>
                </div>
                <div class="col-lg-4">
                    <div class="chart-box">
                        <div class="chart-title">Top Productores (Forecast)</div>
                        <div style="height: 300px; position: relative;">
                            <canvas id="chartDonut"></canvas>
                        </div>
                        <div class="text-center mt-3 small text-muted">
                            Basado en Venta Real + Tuber칤a
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="view-registro" style="display: none;">
            <div class="chart-box">
                <div class="d-flex justify-content-between align-items-center mb-3">
                    <h5 class="fw-bold m-0 text-primary">Base de Datos Editable</h5>
                    <div class="btn-group">
                        <button class="btn btn-sm btn-outline-secondary" onclick="gridInstance.insertRow()">+ Fila</button>
                        <button class="btn btn-sm btn-outline-danger" onclick="gridInstance.deleteRow()">- Fila</button>
                        <button class="btn btn-sm btn-success" onclick="document.getElementById('fileUpload').click()">Importar Excel</button>
                        <button class="btn btn-sm btn-primary fw-bold" onclick="guardarCambios()">游 GUARDAR CAMBIOS</button>
                    </div>
                    <input type="file" id="fileUpload" hidden onchange="importarExcel(this)" />
                </div>
                <div id="spreadsheet"></div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

    <script>
        // --- 1. CREDENCIALES ---
        const supabaseUrl = 'https://mgnpegrrkxgghzmnlvid.supabase.co'
        const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nbnBlZ3Jya3hnZ2h6bW5sdmlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MjMzMTIsImV4cCI6MjA4MjI5OTMxMn0.rQHpVNlGTT9NVMsEKPUkfA4c3_FXpiEEdJ2oyJaT_jg'
        const client = supabase.createClient(supabaseUrl, supabaseKey)

        // VARIABLES GLOBALES
        let gridInstance = null;
        let mainChart = null;
        let donutChart = null;

        // INICIALIZACI칍N
        document.addEventListener('DOMContentLoaded', () => {
            document.getElementById('fechaHoy').innerText = "Actualizado: " + new Date().toLocaleDateString('es-ES', { weekday: 'long', year: 'numeric', month: 'long', day: 'numeric' });
            cargarDashboard();
            cargarGrid();
        });

        // NAVEGACI칍N
        function switchTab(tab, element) {
            document.getElementById('view-dashboard').style.display = tab === 'dashboard' ? 'block' : 'none';
            document.getElementById('view-registro').style.display = tab === 'registro' ? 'block' : 'none';
            document.querySelectorAll('.nav-item').forEach(el => el.classList.remove('active'));
            if(element) element.classList.add('active');
        }

        // --- 2. L칍GICA DASHBOARD (KPIs Y GR츼FICOS) ---
        async function cargarDashboard() {
            const anio = parseInt(document.getElementById('filtroAnio').value);
            const { data } = await client.from('ventas').select('*').eq('anio', anio);
            if(!data) return;

            // A. C츼LCULO DE TOTALES
            let totalVenta = 0;
            let totalMeta = 0;
            let totalTuberia = 0;

            // Datos mensuales para gr치fico
            const mesesLabels = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
            const arrVenta = new Array(12).fill(0);
            const arrMeta = new Array(12).fill(0);
            const arrTuberia = new Array(12).fill(0);

            // Datos vendedores
            const vendedoresMap = {};

            data.forEach(d => {
                // Sumas totales
                totalVenta += d.venta || 0;
                totalMeta += d.meta || 0;
                totalTuberia += d.tuberia || 0; // NUEVO CAMPO

                // Arreglos mensuales
                const mesIdx = mesesLabels.indexOf(d.mes);
                if(mesIdx >= 0) {
                    arrVenta[mesIdx] += d.venta || 0;
                    arrMeta[mesIdx] += d.meta || 0;
                    arrTuberia[mesIdx] += d.tuberia || 0;
                }

                // Mapa vendedores (Forecast = Venta + Tuberia)
                const forecastVendedor = (d.venta || 0) + (d.tuberia || 0);
                if(!vendedoresMap[d.vendedor]) vendedoresMap[d.vendedor] = 0;
                vendedoresMap[d.vendedor] += forecastVendedor;
            });

            // B. ACTUALIZAR KPI CARDS
            const totalForecast = totalVenta + totalTuberia;
            const gap = totalMeta - totalForecast; // Gap usando Forecast
            const cumplimiento = totalMeta > 0 ? (totalForecast / totalMeta) * 100 : 0;

            const money = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD', maximumFractionDigits: 0 });

            document.getElementById('valVenta').innerText = money.format(totalVenta);
            document.getElementById('valTuberia').innerText = money.format(totalTuberia);
            document.getElementById('valForecast').innerText = money.format(totalForecast);
            document.getElementById('valMeta').innerText = money.format(totalMeta);
            document.getElementById('valGap').innerText = gap > 0 ? "-" + money.format(gap) : "+ Meta Superada";
            
            // Color din치mico GAP
            const gapEl = document.getElementById('valGap');
            if(gap > 0) { gapEl.style.color = "#c0392b"; } else { gapEl.style.color = "#27ae60"; }
            
            document.getElementById('txtCumplimiento').innerText = cumplimiento.toFixed(1) + "% Cubierto (Forecast)";

            // C. RENDERIZAR GR츼FICO PRINCIPAL (COMBO CHART)
            renderMainChart(mesesLabels, arrVenta, arrTuberia, arrMeta);

            // D. RENDERIZAR GR츼FICO TOP VENDEDORES
            const topVendedores = Object.keys(vendedoresMap)
                .map(v => ({ nombre: v, total: vendedoresMap[v] }))
                .sort((a,b) => b.total - a.total)
                .slice(0, 5);
            renderDonutChart(topVendedores);
        }

        function renderMainChart(labels, ventas, tuberias, metas) {
            const ctx = document.getElementById('chartMain').getContext('2d');
            if(mainChart) mainChart.destroy();

            // Configuramos un gr치fico MIXTO
            mainChart = new Chart(ctx, {
                type: 'bar',
                data: {
                    labels: labels,
                    datasets: [
                        {
                            label: 'Venta Cerrada',
                            data: ventas,
                            backgroundColor: '#3498db',
                            order: 2,
                            borderRadius: 4
                        },
                        {
                            label: 'Tuber칤a (Proy)',
                            data: tuberias,
                            backgroundColor: 'rgba(243, 156, 18, 0.6)', // Naranja transl칰cido
                            borderColor: 'rgba(243, 156, 18, 1)',
                            borderWidth: 1,
                            borderDash: [5, 5], // Borde punteado para indicar proyecci칩n
                            order: 3,
                            borderRadius: 4
                        },
                        {
                            type: 'line',
                            label: 'Meta',
                            data: metas,
                            borderColor: '#27ae60',
                            borderWidth: 3,
                            pointBackgroundColor: '#fff',
                            pointBorderColor: '#27ae60',
                            pointRadius: 4,
                            fill: false,
                            tension: 0.4, // Curva suave
                            order: 1
                        }
                    ]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    plugins: {
                        legend: { position: 'top', align: 'end' },
                        tooltip: { mode: 'index', intersect: false }
                    },
                    scales: {
                        x: { stacked: true, grid: { display: false } }, // Barras apiladas
                        y: { stacked: false, grid: { borderDash: [4] }, beginAtZero: true } // Venta+Tuberia apilados? Mejor separados o apilados para ver Forecast total. Vamos a apilarlos.
                    }
                }
            });
            
            // Ajuste para apilar Venta + Tuberia visualmente
            mainChart.options.scales.x.stacked = true;
            mainChart.options.scales.y.stacked = true;
            mainChart.update();
        }

        function renderDonutChart(data) {
            const ctx = document.getElementById('chartDonut').getContext('2d');
            if(donutChart) donutChart.destroy();

            donutChart = new Chart(ctx, {
                type: 'doughnut',
                data: {
                    labels: data.map(d => d.nombre),
                    datasets: [{
                        data: data.map(d => d.total),
                        backgroundColor: ['#2c3e50', '#3498db', '#1abc9c', '#f1c40f', '#e74c3c'],
                        borderWidth: 0,
                        hoverOffset: 15
                    }]
                },
                options: {
                    responsive: true,
                    maintainAspectRatio: false,
                    cutout: '70%',
                    plugins: {
                        legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                    }
                }
            });
        }

        // --- 3. L칍GICA DE HOJA DE C츼LCULO (CON CAMPO TUBER칈A) ---
        async function cargarGrid() {
            // Pedimos el nuevo campo 'tuberia'
            const { data } = await client
                .from('ventas')
                .select('id, vendedor, anio, mes, venta, meta, tuberia')
                .order('anio', { ascending: false });

            const gridData = data ? data.map(i => [
                i.id, i.vendedor, i.anio, i.mes, i.venta, i.tuberia, i.meta
            ]) : [];

            if(gridInstance) document.getElementById('spreadsheet').innerHTML = '';

            gridInstance = jspreadsheet(document.getElementById('spreadsheet'), {
                data: gridData,
                columns: [
                    { type: 'hidden', title: 'ID', width: 0 },
                    { type: 'text', title: 'Vendedor', width: 200 },
                    { type: 'numeric', title: 'A침o', width: 60 },
                    { type: 'dropdown', title: 'Mes', width: 100, source: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"] },
                    // COLUMNAS FINANCIERAS
                    { type: 'numeric', title: 'Venta Real', width: 110, mask: '#,##0.00', decimal: '.' },
                    { type: 'numeric', title: 'Tuber칤a (Proy)', width: 110, mask: '#,##0.00', decimal: '.', color: '#e67e22' }, // Color naranja al texto
                    { type: 'numeric', title: 'Meta', width: 110, mask: '#,##0.00', decimal: '.' },
                ],
                minDimensions: [10, 10],
                defaultColAlign: 'left',
                allowInsertColumn: false, // Bloqueado para no romper BD
            });
        }

        async function guardarCambios() {
            const rawData = gridInstance.getData();
            const clean = (v) => v ? parseFloat(String(v).replace(/,/g, '')) : 0;
            const upsertData = [];

            rawData.forEach(row => {
                if(row[1]) {
                    upsertData.push({
                        id: (row[0] && row[0].length > 5) ? row[0] : crypto.randomUUID(),
                        vendedor: row[1],
                        anio: parseInt(row[2]) || 2025,
                        mes: row[3] || 'Enero',
                        venta: clean(row[4]),
                        tuberia: clean(row[5]), // GUARDAR NUEVO CAMPO
                        meta: clean(row[6])
                    });
                }
            });

            Swal.fire({title: 'Guardando...', didOpen: () => Swal.showLoading()});
            const { error } = await client.from('ventas').upsert(upsertData);
            
            if(!error) {
                Swal.fire({icon: 'success', title: 'Actualizado', timer: 1000, showConfirmButton: false});
                cargarDashboard();
            } else {
                Swal.fire('Error', error.message, 'error');
            }
        }

        function importarExcel(input) {
            const file = input.files[0];
            if(!file) return;
            const reader = new FileReader();
            reader.onload = function(e) {
                const workbook = XLSX.read(new Uint8Array(e.target.result), {type: 'array'});
                const jsonData = XLSX.utils.sheet_to_json(workbook.Sheets[workbook.SheetNames[0]], {header: 1});
                jsonData.forEach((row, i) => {
                    // Mapeo simple suponiendo orden: Vendedor, A침o, Mes, Venta, Tuberia, Meta
                    if(i>0 && row[0]) gridInstance.insertRow(["", row[0], row[1], row[2], row[3], row[4], row[5]]);
                });
                input.value = '';
            };
            reader.readAsArrayBuffer(file);
        }
    </script>
</body>
</html>
