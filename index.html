<!DOCTYPE html>
<html lang="es">
<head>
  <meta charset="UTF-8">
  <meta name="viewport" content="width=device-width, initial-scale=1">
  <title>Dashboard Admin | Ventas</title>
  
  <link href="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/css/bootstrap.min.css" rel="stylesheet">
  <link rel="stylesheet" href="https://cdn.jsdelivr.net/npm/bootstrap-icons@1.11.0/font/bootstrap-icons.css">
  <script src="https://cdn.jsdelivr.net/npm/sweetalert2@11"></script>
  <script src="https://cdn.jsdelivr.net/npm/@supabase/supabase-js@2"></script>
  <script src="https://cdn.jsdelivr.net/npm/chart.js"></script>
  
  <script src="https://bossanova.uk/jspreadsheet/v4/jexcel.js"></script>
  <link rel="stylesheet" href="https://bossanova.uk/jspreadsheet/v4/jexcel.css" type="text/css" />
  <script src="https://jsuites.net/v4/jsuites.js"></script>
  <link rel="stylesheet" href="https://jsuites.net/v4/jsuites.css" type="text/css" />
  
  <style>
    :root {
        --sidebar-width: 260px;
        --primary-color: #4e73df;
        --secondary-color: #858796;
        --bg-color: #f8f9fc;
    }

    body { background-color: var(--bg-color); font-family: 'Nunito', sans-serif; overflow-x: hidden; }

    /* SIDEBAR ESTILO FAB ADMIN */
    .sidebar {
        width: var(--sidebar-width);
        position: fixed;
        top: 0; left: 0; height: 100vh;
        background: linear-gradient(180deg, #4e73df 10%, #224abe 100%);
        color: white;
        padding-top: 20px;
        z-index: 1000;
        transition: all 0.3s;
    }
    .sidebar-brand { padding: 15px 25px; font-size: 1.2rem; font-weight: 800; letter-spacing: 1px; text-transform: uppercase; }
    .nav-item { padding: 10px 20px; cursor: pointer; opacity: 0.8; transition: 0.2s; display: flex; align-items: center; gap: 10px; }
    .nav-item:hover, .nav-item.active { opacity: 1; background: rgba(255,255,255,0.1); border-left: 4px solid white; }
    .nav-item i { font-size: 1.1rem; }

    /* CONTENIDO PRINCIPAL */
    .main-content { margin-left: var(--sidebar-width); padding: 30px; transition: all 0.3s; }

    /* TARJETAS KPI (TOP WIDGETS) */
    .kpi-card {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        border-left: 5px solid var(--primary-color);
        height: 100%;
        display: flex;
        justify-content: space-between;
        align-items: center;
    }
    .kpi-title { font-size: 0.8rem; font-weight: 700; text-transform: uppercase; color: var(--primary-color); margin-bottom: 5px; }
    .kpi-value { font-size: 1.5rem; font-weight: 700; color: #5a5c69; }
    .kpi-icon { font-size: 2rem; color: #dddfeb; }

    /* GRÁFICOS Y CONTENEDORES */
    .chart-container {
        background: white;
        border-radius: 15px;
        padding: 25px;
        box-shadow: 0 4px 15px rgba(0,0,0,0.03);
        margin-bottom: 30px;
    }
    .chart-header { display: flex; justify-content: space-between; align-items: center; margin-bottom: 20px; }
    .chart-title { font-weight: 700; color: var(--primary-color); }

    /* HOJA DE CÁLCULO */
    .jexcel_content { border: none; }
    .jexcel > thead > tr > td { background-color: #eaecf4; color: #4e73df; font-weight: bold; }

    /* RESPONSIVE */
    @media (max-width: 768px) {
        .sidebar { margin-left: calc(var(--sidebar-width) * -1); }
        .main-content { margin-left: 0; }
        .sidebar.active { margin-left: 0; }
    }
  </style>
</head>
<body>

    <div class="sidebar" id="sidebar">
        <div class="sidebar-brand">
            <i class="bi bi-buildings-fill me-2"></i> GESTIÓN
        </div>
        <hr class="mx-3" style="background: white;">
        
        <div class="nav-item active" onclick="mostrarSeccion('dashboard')">
            <i class="bi bi-speedometer2"></i> Dashboard
        </div>
        <div class="nav-item" onclick="mostrarSeccion('registro')">
            <i class="bi bi-table"></i> Hoja de Datos
        </div>
        <div class="nav-item" onclick="window.location.href='index.html'">
            <i class="bi bi-box-arrow-left"></i> Salir
        </div>
    </div>

    <div class="main-content">
        
        <div class="d-flex justify-content-between align-items-center mb-4">
            <h3 class="text-gray-800 fw-bold">Panel de Control</h3>
            <select id="filtroAnio" class="form-select w-auto shadow-sm" onchange="cargarDashboard()">
                <option value="2024">Año 2024</option>
                <option value="2025" selected>Año 2025</option>
                <option value="2026">Año 2026</option>
            </select>
        </div>

        <div id="seccion-dashboard">
            <div class="row mb-4">
                <div class="col-md-3 mb-3">
                    <div class="kpi-card" style="border-left-color: #4e73df;">
                        <div>
                            <div class="kpi-title" style="color: #4e73df;">Venta Anual (Total)</div>
                            <div class="kpi-value" id="kpiVenta">$0.00</div>
                        </div>
                        <i class="bi bi-currency-dollar kpi-icon"></i>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="kpi-card" style="border-left-color: #1cc88a;">
                        <div>
                            <div class="kpi-title" style="color: #1cc88a;">Meta Anual</div>
                            <div class="kpi-value" id="kpiMeta">$0.00</div>
                        </div>
                        <i class="bi bi-flag-fill kpi-icon"></i>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="kpi-card" style="border-left-color: #36b9cc;">
                        <div>
                            <div class="kpi-title" style="color: #36b9cc;">% Cumplimiento</div>
                            <div class="kpi-value" id="kpiPorc">0%</div>
                        </div>
                        <i class="bi bi-pie-chart-fill kpi-icon"></i>
                    </div>
                </div>
                <div class="col-md-3 mb-3">
                    <div class="kpi-card" style="border-left-color: #f6c23e;">
                        <div>
                            <div class="kpi-title" style="color: #f6c23e;">Promedio Mensual</div>
                            <div class="kpi-value" id="kpiPromedio">$0.00</div>
                        </div>
                        <i class="bi bi-calendar-week kpi-icon"></i>
                    </div>
                </div>
            </div>

            <div class="row">
                <div class="col-lg-8">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h6 class="chart-title">Resumen de Ingresos</h6>
                        </div>
                        <div style="height: 350px; width: 100%;">
                            <canvas id="graficoMensual"></canvas>
                        </div>
                    </div>
                </div>

                <div class="col-lg-4">
                    <div class="chart-container">
                        <div class="chart-header">
                            <h6 class="chart-title">Top Vendedores</h6>
                        </div>
                        <div style="height: 320px; width: 100%;">
                            <canvas id="graficoVendedores"></canvas>
                        </div>
                        <div class="text-center mt-3 small text-muted">
                            * Vendedores con mayor producción acumulada
                        </div>
                    </div>
                </div>
            </div>
        </div>

        <div id="seccion-registro" style="display: none;">
            <div class="chart-container">
                <div class="d-flex justify-content-between mb-3">
                    <h5 class="fw-bold text-primary">Base de Datos Editable</h5>
                    <div class="d-flex gap-2">
                         <button class="btn btn-sm btn-outline-primary" onclick="addRow()">+ Fila</button>
                         <button class="btn btn-sm btn-outline-danger" onclick="deleteRow()">- Fila</button>
                         <button class="btn btn-sm btn-outline-secondary" onclick="addColumn()">+ Columna</button>
                         <button class="btn btn-sm btn-outline-secondary" onclick="deleteColumn()">- Columna</button>
                         <button class="btn btn-sm btn-success text-white" onclick="document.getElementById('fileUpload').click()">Importar Excel</button>
                         <input type="file" id="fileUpload" hidden onchange="importarExcel(this)" />
                         <button class="btn btn-sm btn-primary fw-bold" onclick="guardarCambios()">GUARDAR TODO</button>
                    </div>
                </div>
                <div id="spreadsheet"></div>
            </div>
        </div>

    </div>

    <script src="https://cdn.jsdelivr.net/npm/bootstrap@5.3.0/dist/js/bootstrap.bundle.min.js"></script>

  <script>
    // --- CREDENCIALES ---
    const supabaseUrl = 'https://mgnpegrrkxgghzmnlvid.supabase.co'
    const supabaseKey = 'eyJhbGciOiJIUzI1NiIsInR5cCI6IkpXVCJ9.eyJpc3MiOiJzdXBhYmFzZSIsInJlZiI6Im1nbnBlZ3Jya3hnZ2h6bW5sdmlkIiwicm9sZSI6ImFub24iLCJpYXQiOjE3NjY3MjMzMTIsImV4cCI6MjA4MjI5OTMxMn0.rQHpVNlGTT9NVMsEKPUkfA4c3_FXpiEEdJ2oyJaT_jg'
    const client = supabase.createClient(supabaseUrl, supabaseKey)
    
    let gridInstance = null;
    let chartMensual = null;
    let chartVendedores = null;

    // INICIO
    document.addEventListener('DOMContentLoaded', () => {
        cargarDashboard();
        cargarGrid();
    });

    // --- NAVEGACIÓN SIMPLE ---
    function mostrarSeccion(seccion) {
        document.getElementById('seccion-dashboard').style.display = seccion === 'dashboard' ? 'block' : 'none';
        document.getElementById('seccion-registro').style.display = seccion === 'registro' ? 'block' : 'none';
        
        // Actualizar clase active en sidebar
        const items = document.querySelectorAll('.nav-item');
        items.forEach(i => i.classList.remove('active'));
        if(seccion === 'dashboard') items[0].classList.add('active');
        if(seccion === 'registro') items[1].classList.add('active');
    }

    // --- 1. DASHBOARD PREMIUM (ESTILO FAB ADMIN) ---
    async function cargarDashboard() {
        const anio = parseInt(document.getElementById('filtroAnio').value);
        const { data } = await client.from('ventas').select('*').eq('anio', anio);
        
        if(!data) return;

        // A. CÁLCULO DE TARJETAS (KPIs)
        let totalVenta = 0;
        let totalMeta = 0;
        
        data.forEach(d => {
            totalVenta += d.venta;
            totalMeta += d.meta;
        });

        const porcentaje = totalMeta > 0 ? (totalVenta / totalMeta) * 100 : 0;
        const promedio = data.length > 0 ? (totalVenta / data.length) : 0;

        // Actualizar DOM con formato moneda
        const formato = new Intl.NumberFormat('en-US', { style: 'currency', currency: 'USD' });
        
        document.getElementById('kpiVenta').innerText = formato.format(totalVenta);
        document.getElementById('kpiMeta').innerText = formato.format(totalMeta);
        document.getElementById('kpiPorc').innerText = porcentaje.toFixed(1) + "%";
        document.getElementById('kpiPromedio').innerText = formato.format(promedio);

        // B. GRÁFICO DE LÍNEAS (ÁREA)
        const meses = ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"];
        const dataVentas = new Array(12).fill(0);
        
        data.forEach(row => {
            const idx = meses.indexOf(row.mes);
            if(idx >= 0) dataVentas[idx] += row.venta;
        });

        renderChartArea(meses, dataVentas);

        // C. GRÁFICO DE DONA (TOP VENDEDORES)
        const vendedoresMap = {};
        data.forEach(row => {
            if(!vendedoresMap[row.vendedor]) vendedoresMap[row.vendedor] = 0;
            vendedoresMap[row.vendedor] += row.venta;
        });
        const vendedoresArray = Object.keys(vendedoresMap).map(v => ({ nombre: v, total: vendedoresMap[v] }));
        vendedoresArray.sort((a, b) => b.total - a.total);
        
        renderChartDona(vendedoresArray.slice(0, 5));
    }

    function renderChartArea(labels, data) {
        const ctx = document.getElementById('graficoMensual').getContext('2d');
        if(chartMensual) chartMensual.destroy();

        // DEGRADADO PRECIOSO
        const gradient = ctx.createLinearGradient(0, 0, 0, 400);
        gradient.addColorStop(0, 'rgba(78, 115, 223, 0.4)');
        gradient.addColorStop(1, 'rgba(78, 115, 223, 0.05)');

        chartMensual = new Chart(ctx, {
            type: 'line',
            data: {
                labels: labels,
                datasets: [{
                    label: 'Ingresos',
                    data: data,
                    backgroundColor: gradient,
                    borderColor: '#4e73df',
                    pointBackgroundColor: '#fff',
                    pointBorderColor: '#4e73df',
                    pointHoverBackgroundColor: '#4e73df',
                    pointHoverBorderColor: '#fff',
                    fill: true,
                    tension: 0.4, // Curva suave
                    borderWidth: 3
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                plugins: { legend: { display: false } },
                scales: {
                    x: { grid: { display: false } },
                    y: { grid: { borderDash: [5], color: '#f0f0f0' }, beginAtZero: true }
                }
            }
        });
    }

    function renderChartDona(data) {
        const ctx = document.getElementById('graficoVendedores').getContext('2d');
        if(chartVendedores) chartVendedores.destroy();

        chartVendedores = new Chart(ctx, {
            type: 'doughnut',
            data: {
                labels: data.map(d => d.nombre),
                datasets: [{
                    data: data.map(d => d.total),
                    backgroundColor: ['#4e73df', '#1cc88a', '#36b9cc', '#f6c23e', '#e74a3b'],
                    borderWidth: 5,
                    borderColor: '#fff',
                    hoverOffset: 10
                }]
            },
            options: {
                responsive: true,
                maintainAspectRatio: false,
                cutout: '75%', // Dona delgada
                plugins: {
                    legend: { position: 'bottom', labels: { usePointStyle: true, padding: 20 } }
                }
            }
        });
    }

    // --- 2. HOJA DE DATOS (TABLA) ---
    async function cargarGrid() {
        const { data } = await client.from('ventas').select('id, vendedor, anio, mes, venta, meta').order('anio', { ascending: false });
        
        const gridData = data ? data.map(i => [i.id, i.vendedor, i.anio, i.mes, i.venta, i.meta]) : [];
        if(gridInstance) document.getElementById('spreadsheet').innerHTML = '';

        gridInstance = jspreadsheet(document.getElementById('spreadsheet'), {
            data: gridData,
            columns: [
                { type: 'hidden', title: 'ID', width: 0 },
                { type: 'text', title: 'Vendedor', width: 220 },
                { type: 'numeric', title: 'Año', width: 80 },
                { type: 'dropdown', title: 'Mes', width: 120, source: ["Enero", "Febrero", "Marzo", "Abril", "Mayo", "Junio", "Julio", "Agosto", "Septiembre", "Octubre", "Noviembre", "Diciembre"] },
                { type: 'numeric', title: 'Venta', width: 130, mask: '#,##0.00', decimal: '.' },
                { type: 'numeric', title: 'Meta', width: 130, mask: '#,##0.00', decimal: '.' }
            ],
            minDimensions: [6, 12],
            defaultColAlign: 'left',
            allowInsertColumn: true,
            allowManualInsertColumn: true,
        });
    }

    // FUNCIONES CRUD Y BOTONES (Igual que antes)
    function addRow() { gridInstance.insertRow(); }
    function deleteRow() { gridInstance.deleteRow(); }
    function addColumn() { gridInstance.insertColumn(); }
    function deleteColumn() { gridInstance.deleteColumn(); }
    
    async function guardarCambios() {
        const rawData = gridInstance.getData();
        const cleanNumber = (v) => v ? parseFloat(String(v).replace(/,/g, '')) : 0;
        const upsertData = [];

        rawData.forEach(row => {
            if(row[1]) {
                const record = {
                    id: (row[0] && row[0].length > 5) ? row[0] : crypto.randomUUID(),
                    vendedor: row[1],
                    anio: parseInt(row[2]) || 2025,
                    mes: row[3] || 'Enero',
                    venta: cleanNumber(row[4]),
                    meta: cleanNumber(row[5])
                };
                upsertData.push(record);
            }
        });

        Swal.fire({title: 'Guardando...', didOpen: () => Swal.showLoading()});
        const { error } = await client.from('ventas').upsert(upsertData);
        
        if(!error) {
            Swal.fire({icon: 'success', title: 'Guardado', timer: 1500, showConfirmButton: false});
            cargarDashboard(); // Actualiza los gráficos al guardar
        } else {
            Swal.fire('Error', error.message, 'error');
        }
    }

    // IMPORTAR EXCEL
    function importarExcel(input) {
        // (Tu misma lógica de importación va aquí, simplificada para ahorrar espacio en esta respuesta)
        const file = input.files[0];
        if(!file) return;
        const reader = new FileReader();
        reader.onload = function(e) {
            const data = new Uint8Array(e.target.result);
            const workbook = XLSX.read(data, {type: 'array'});
            const firstSheet = workbook.Sheets[workbook.SheetNames[0]];
            const jsonData = XLSX.utils.sheet_to_json(firstSheet, {header: 1});
            jsonData.forEach((row, i) => {
               if(i>0 && row[0]) gridInstance.insertRow(["", row[0], row[1], row[2], row[3], row[4]]);
            });
            input.value = '';
        };
        reader.readAsArrayBuffer(file);
    }
  </script>
</body>
</html>
